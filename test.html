<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Plate-forme 3D avec Three.js</title>
    <style>
        body {
            margin: 0;
        }
    </style>
    <script type="importmap">
        {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/",
            "ammo.js": "https://unpkg.com/ammo.js@2.0.0/builds/ammo.wasm.js"
        }
        }
    </script>
</head>

<body>
    <script type="module">
        import * as THREE from 'three';
        import * as Ammo from 'ammo.js';
        
        // Création de la scène
        const scene = new THREE.Scene();

        // Configuration de la caméra
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, -10, 5);
        camera.rotation.x = 1.2;
        camera.lookAt(0, 0, 0);

        // Création du rendu
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Création platform
        const platformGeometry = new THREE.PlaneGeometry(10, 10);
        const platformMaterial = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        const platform = new THREE.Mesh(platformGeometry, platformMaterial);
        scene.add(platform);

        // Création cube
        const characterGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
        const characterMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const character = new THREE.Mesh(characterGeometry, characterMaterial);
        scene.add(character);

        character.position.set(0, 1, 1);

        // Variables pour le mouvement
        const moveSpeed = 0.1;

        // Créez un monde physique avec Ammo.js
        const collisionConfiguration = new Ammo.btDefaultCollisionConfiguration();
        const dispatcher = new Ammo.btCollisionDispatcher(collisionConfiguration);
        const overlappingPairCache = new Ammo.btDbvtBroadphase();
        const solver = new Ammo.btSequentialImpulseConstraintSolver();
        const dynamicsWorld = new Ammo.btDiscreteDynamicsWorld(dispatcher, overlappingPairCache, solver, collisionConfiguration);

        // Définissez la gravité
        dynamicsWorld.setGravity(new Ammo.btVector3(0, -9.8, 0));

        // Créez une forme physique pour le personnage (cube)
        const characterShape = new Ammo.btBoxShape(new Ammo.btVector3(0.25, 0.25, 0.25));

        // Créez un transformeur pour la position initiale du personnage
        const characterTransform = new Ammo.btTransform();
        characterTransform.setIdentity();
        characterTransform.setOrigin(new Ammo.btVector3(0, 1, 1)); // Position initiale

        // Créez des propriétés pour le corps physique du personnage
        const characterMass = 1; // Masse du personnage
        const localInertia = new Ammo.btVector3(0, 0, 0);

        // Calculez l'inertie locale (nécessaire pour les objets dynamiques)
        characterShape.calculateLocalInertia(characterMass, localInertia);

        // Créez un corps physique pour le personnage
        const characterMotionState = new Ammo.btDefaultMotionState(characterTransform);
        const characterInfo = new Ammo.btRigidBodyConstructionInfo(characterMass, characterMotionState, characterShape, localInertia);
        const characterBody = new Ammo.btRigidBody(characterInfo);

        // Ajoutez le corps physique du personnage au monde physique
        dynamicsWorld.addRigidBody(characterBody);

        // Créez une forme physique pour la plateforme (plan statique)
        const platformShape = new Ammo.btStaticPlaneShape(new Ammo.btVector3(0, 1, 0), 0); // Plan dans la direction Y

        // Créez un transformeur pour la position de la plateforme
        const platformTransform = new Ammo.btTransform();
        platformTransform.setIdentity();
        platformTransform.setOrigin(new Ammo.btVector3(0, 0, 0)); // Position initiale de la plateforme

        // Créez des propriétés pour le corps physique de la plateforme
        const platformInfo = new Ammo.btRigidBodyConstructionInfo(0, null, platformShape, new Ammo.btVector3(0, 0, 0));
        const platformBody = new Ammo.btRigidBody(platformInfo);

        // Ajoutez le corps physique de la plateforme au monde physique
        dynamicsWorld.addRigidBody(platformBody);

        // Mettez à jour la position du personnage en utilisant le corps physique
        const characterPosition = characterBody.getWorldTransform().getOrigin();

        // Gérer les événements du clavier
        const onKeyDown = (event) => {
            let impulse;
            switch (event.key) {
                case "ArrowUp":
                    impulse = new Ammo.btVector3(0, moveSpeed, 0);
                    break;
                case "ArrowDown":
                    impulse = new Ammo.btVector3(0, -moveSpeed, 0);
                    break;
                case "ArrowLeft":
                    impulse = new Ammo.btVector3(-moveSpeed, 0, 0);
                    break;
                case "ArrowRight":
                    impulse = new Ammo.btVector3(moveSpeed, 0, 0);
                    break;
            }
            characterBody.applyCentralImpulse(impulse);
        };

        document.addEventListener("keydown", onKeyDown);

        const animate = () => {
            requestAnimationFrame(animate);

            // Mettre à jour la position du personnage
            characterBody.getWorldTransform().setOrigin(characterPosition);

            // Mettez à jour la simulation physique
            dynamicsWorld.stepSimulation(1 / 60, 10);

            renderer.render(scene, camera);
        };

        animate();
    </script>
</body>

</html>
